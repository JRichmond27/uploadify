/*!
UploadiFive 1.2.3
Copyright (c) 2012 Reactive Apps, Ronnie Garcia
Released under the UploadiFive Commercial License <http://www.uploadify.com/download/download-uploadifive-commercial/>
Fixes by Andrew Koransky / InfoTank, Inc. - first fix is the line above.  I bought the commercial license not the Standard license.  Search for "ASK - FIX" for my fixes.
Additional Fixes by Jeff Richmond - Search for "JR - FIX" for my fixes and optimizations.
*/
const DEBUG_UL5=!0;(function(n){var t={init:function(i){return DEBUG_UL5&&console.log("%cinit",LOG_START),this.each(function(){var f=n(this),r,u,s,o,e;if(f.data("uploadifive",{inputs:{},inputCount:0,fileID:0,queue:{count:0,selected:0,replaced:0,errors:0,queued:0,cancelled:0},checking:0,uploads:{current:0,attempts:0,successful:0,errors:0,count:0}}),r=f.data("uploadifive"),u=r.settings=n.extend({auto:!0,buttonClass:!1,buttonText:"Select Files",checkScript:!1,dnd:!0,dropTarget:!1,fileObjName:"Filedata",fileSizeLimit:0,fileType:!1,formData:{},height:30,itemTemplate:!1,method:"post",multi:!0,overrideEvents:[],queueID:!1,queueSizeLimit:0,removeCompleted:!1,simUploadLimit:0,truncateLength:0,uploadLimit:0,uploadScript:"uploadifive.php",width:100,compressImages:!0,imageQuality:.95,imageMaxWidth:2880,imageMaxHeight:2880,imageMaxPNGSize:1e6},i),u.fileType&&(s=u.fileType.split("|")),isNaN(u.fileSizeLimit)?(o=parseInt(u.fileSizeLimit,10)*1.024,u.fileSizeLimit.indexOf("KB")>-1?u.fileSizeLimit=o*1e3:u.fileSizeLimit.indexOf("MB")>-1?u.fileSizeLimit=o*1e6:u.fileSizeLimit.indexOf("GB")>-1&&(u.fileSizeLimit=o*1e9)):u.fileSizeLimit=u.fileSizeLimit*1024,r.inputTemplate=n('<input type="file">'),r.createInput=function(){DEBUG_UL5&&console.log("%ccreateInput",LOG_START);var i=r.inputTemplate.clone(),e=i.name="input"+r.inputCount++;i.attr("id",e);u.multi&&i.attr("multiple",!0);u.fileType&&i.attr("accept",u.fileType);i.bind("change",function(){var i,o;if(DEBUG_UL5&&console.log("%cinput_change",LOG_START),r.queue.selected=0,r.queue.replaced=0,r.queue.errors=0,r.queue.queued=0,i=this.files.length,r.queue.selected=i,r.queue.count+i>u.queueSizeLimit&&u.queueSizeLimit!==0)n.inArray("onError",u.overrideEvents)<0&&alert("The maximum number of queue items has been reached ("+u.queueSizeLimit+").  Please select fewer files."),typeof u.onError=="function"&&u.onError.call(f,"QUEUE_LIMIT_EXCEEDED");else{for(o=0;o<i;o++)file=this.files[o],r.addQueueItem(file);r.inputs[e]=this;r.createInput()}u.auto&&t.upload.call(f);typeof u.onSelect=="function"&&u.onSelect.call(f,r.queue)});r.currentInput&&r.currentInput.hide();r.button.append(i);r.currentInput=i},r.destroyInput=function(t){n(r.inputs[t]).remove();delete r.inputs[t];r.inputCount--},r.cleanInputs=function(){var t,n;for(t in r.inputs){var i=r.inputs[t],u=i.files.length,f=0;for(n=0;n<u;n++)i.files[n].skip&&f++;f>=u&&r.destroyInput(t)}},r.drop=function(i){var o,h;if(i.preventDefault(),i.stopPropagation(),navigator.userAgent.toLowerCase().indexOf("safari/")!==-1&&navigator.userAgent.toLowerCase().indexOf("windows")!==-1&&navigator.userAgent.toLowerCase().indexOf("chrome")===-1){alert("Drag and drop in Safari on windows is not supported.");return}r.queue.selected=0;r.queue.replaced=0;r.queue.errors=0;r.queue.queued=0;var e=i.dataTransfer,l=e.name="input"+r.inputCount++,c=e.files.length;if(r.queue.selected=c,r.queue.count+c>u.queueSizeLimit&&u.queueSizeLimit!==0)n.inArray("onError",u.overrideEvents)<0&&alert("The maximum number of queue items has been reached ("+u.queueSizeLimit+").  Please select fewer files."),typeof u.onError=="function"&&u.onError.call(f,"QUEUE_LIMIT_EXCEEDED");else{for(o={},o.name=e.name,o.files=jQuery.extend(!0,{},e.files),h=0;h<c;h++)file=e.files[h],r.addQueueItem(o.files[h]),s&&s.indexOf(file.type)===-1&&r.error("FORBIDDEN_FILE_TYPE",file);r.inputs[l]=o}u.auto&&t.upload.call(f);typeof u.onDrop=="function"&&u.onDrop.call(f,e.files,e.files.length)},r.fileExistsInQueue=function(n){var i,t;for(i in r.inputs)for(input=r.inputs[i],limit=input.files.length,t=0;t<limit;t++)if(existingFile=input.files[t],existingFile.name===n.name&&!existingFile.complete)return!0;return!1},r.removeExistingFile=function(n){var u,i;for(u in r.inputs)for(input=r.inputs[u],limit=input.files.length,i=0;i<limit;i++)existingFile=input.files[i],existingFile.name!==n.name||existingFile.complete||(r.queue.replaced++,t.cancel.call(f,existingFile,!0))},r.queueItem=u.itemTemplate===!1?n('<div class="uploadifive-queue-item">                        <a class="close" href="#" title="Remove this upload">Remove<\/a>                        <div><span class="filename"><\/span> <span class="filesize"><\/span> <span class="filestatus"><\/span><\/div>                        <div class="progress">                            <div class="progress-bar"><\/div>                        <\/div>                    <\/div>'):n(u.itemTemplate),r.addQueueItem=function(i){if(DEBUG_UL5&&console.log("%caddQueueItem: "+i.name,LOG_START),n.inArray("onAddQueueItem",u.overrideEvents)<0){r.removeExistingFile(i);i.queueItem=r.queueItem.clone();i.queueItem.attr("id",u.id+"-file-"+r.fileID++);i.queueItem.find(".close").bind("click",function(){return t.cancel.call(f,i),!1});var e=i.name;e.length>u.truncateLength&&u.truncateLength!==0&&(e='<span title="'+e+'">'+e.substring(0,u.truncateLength)+"&hellip;<\/span>");i.queueItem.data("canceled",!1);i.queueItem.find(".filename").html(e);i.queueItem.find(".filesize").html(" ("+filesize(i.size)+")");i.queueItem.data("file",i);r.queueEl.append(i.queueItem)}i.size>u.fileSizeLimit&&u.fileSizeLimit!==0?r.error("FILE_SIZE_LIMIT_EXCEEDED",i):(r.queue.queued++,r.queue.count++);typeof u.onAddQueueItem=="function"&&u.onAddQueueItem.call(f,i)},r.removeQueueItem=function(t,i,u){DEBUG_UL5&&console.log("%cremoveQueueItem: "+t.name,LOG_TEXT);u||(u=0);var f=i?0:500;t.queueItem&&(t.queueItem.data("canceled",!0),t.queueItem.find(".filestatus").html()!=="Completed"&&t.queueItem.find(".filestatus").html("Cancelled"),t.queueItem.find(".progress-bar").width(0),t.queueItem.delay(u).fadeOut(f,function(){n(this).remove()}),delete t.queueItem,r.queue.count--)},r.filesToUpload=function(){var t=0,i,n;for(i in r.inputs)for(input=r.inputs[i],limit=input.files.length,n=0;n<limit;n++)file=input.files[n],file.skip||file.complete||t++;return DEBUG_UL5&&console.log("%cfilesToUpload: "+t,LOG_TEXT),t},r.checkExists=function(i,e){if(DEBUG_UL5&&console.log("%ccheckExists: "+i.name,LOG_START),typeof i.checkStarted!="undefined"&&i.checkStarted)DEBUG_UL5&&console.log("%ccheckExists - File already checked: "+i.name,LOG_TEXT),i.checked&&!i.skip&&e&&r.startFileUpload(i);else if(i.checkStarted=!0,i.checked=!1,r.checking++,n.inArray("onCheck",u.overrideEvents)<0){var o=n.extend(u.formData,{filename:i.name});n.post(u.checkScript,o,function(n){if(n.lastIndexOf("error:",0)!==0?(i.exists=parseInt(n,10),i.checked=!0):alert("An error occurred while checking if the file already exists:\n"+n),i.exists){DEBUG_UL5&&console.log("%ccheckExists - File exists: "+i.name,LOG_IMPORTANT);var o="";o=u.multi?"The file you're uploading ("+i.name+") already exists.\nWould you like to replace it?":"The file you're uploading already exists.\nWould you like to replace it?";confirm(o)?i.skip=!1:(t.cancel.call(f,i),i.skip=!0)}else DEBUG_UL5&&console.log("%ccheckExists - New file: "+i.name,LOG_INFO),i.skip=!1;r.checking--;e&&!i.skip&&r.startFileUpload(i);typeof u.onCheck=="function"&&u.onCheck.call(f,i,i.exists)})}},r.startFileUpload=function(t){DEBUG_UL5&&console.log("%cstartFileUpload: "+t.name,LOG_START);var i=u.UploadLimit,f=u.simUploadLimit,e=r.uploads.current,o=r.uploads.count;if(e>=f&&f!==0||e>=i&&i!==0||o>=i&&i!==0)return DEBUG_UL5&&(console.log("%cstartFileUpload - Queue limit reached: "+n(this).data("file").name,LOG_IMPORTANT),console.log("%c    limit: "+i+"\n    sim limit: "+f+"\n    uploading: "+e+"\n    uploads: "+o,LOG_TEXT)),!1;t.skip||t.uploading||t.complete||r.uploadFile(t,!0)},r.uploadFile=function(t,i){var e,s,o,h;if(DEBUG_UL5&&console.log("%cuploadFile: "+t.name,LOG_START),!t.skip&&!t.uploading&&!t.complete)if(t.uploading=!0,r.uploads.current++,r.uploads.attempted++,xhr=t.xhr=new XMLHttpRequest,typeof FormData=="function"||typeof FormData=="object")if(e=new FormData,DEBUG_UL5&&console.log("%cFile Type: "+t.type,LOG_INFO),u.compressImages&&(t.type==="image/jpeg"||t.type==="image/png"))DEBUG_UL5&&console.log("%cCompress Image ("+u.imageQuality+")",LOG_START),new Compressor(t,{quality:u.imageQuality,maxWidth:u.imageMaxWidth,maxHeight:u.imageMaxHeight,convertSize:u.imageMaxPNGSize,success:function(n){var o,f;DEBUG_UL5&&console.log("%cCompression Complete: "+t.size+"->"+n.size+" "+n.type,LOG_SUCCESS);n.checkStarted=t.checkStarted;n.checked=t.checked;n.complete=t.complete;n.exists=t.exists;n.lastModifiedDate=new Date;n.queueItem=t.queueItem;n.skip=t.skip;n.uploading=t.uploading;n.xhr=t.xhr;t=n;e.append(u.fileObjName,t,t.name);o=!1;for(f in u.formData)f==="filename"?(e.append("filename",t.name),o=!0):e.append(f,u.formData[f]);o||e.append("filename",t.name);xhr.open(u.method,u.uploadScript,!0);xhr.upload.addEventListener("progress",function(n){n.lengthComputable&&r.progress(n,t)},!1);xhr.addEventListener("load",function(n){this.readyState===4&&(t.uploading=!1,this.status===200?t.xhr.responseText.lastIndexOf("error:",0)!==0?r.uploadComplete(n,t,i):r.error(t.xhr.responseText,t,i):this.status===404?(console.log("%cError: "+this.statusText,LOG_ERROR),r.error("404_FILE_NOT_FOUND",t,i)):this.status===403?(console.log("%cError: "+this.statusText,LOG_ERROR),r.error("403_FORBIDDEN",t,i)):r.error("Error:"+t.xhr.responseText,t,i))});xhr.send(e)},error:function(n){console.log("%cError: "+n.message,LOG_ERROR)}});else{DEBUG_UL5&&console.log("%cStart Upload: "+t.name+" ("+t.size+")",LOG_START);e.append(u.fileObjName,t);s=!1;for(o in u.formData)o==="filename"?(e.append("filename",t.name),s=!0):e.append(o,u.formData[o]);s||e.append("filename",t.name);xhr.open(u.method,u.uploadScript,!0);xhr.upload.addEventListener("progress",function(n){n.lengthComputable&&r.progress(n,t)},!1);xhr.addEventListener("load",function(n){this.readyState===4&&(t.uploading=!1,this.status===200?t.xhr.responseText.lastIndexOf("error:",0)!==0?r.uploadComplete(n,t,i):r.error(t.xhr.responseText,t,i):this.status===404?(console.log("%cError: "+this.statusText,LOG_ERROR),r.error("404_FILE_NOT_FOUND",t,i)):this.status===403?(console.log("%cError: "+this.statusText,LOG_ERROR),r.error("403_FORBIDDEN",t,i)):r.error("Error:"+t.xhr.responseText,t,i))});xhr.send(e)}else DEBUG_UL5&&console.log("%cbinary upload: "+t.name,LOG_TEXT),h=new FileReader,h.onload=function(e){var h="-------------------------"+(new Date).getTime(),c="--",o="\r\n",s="",l,a,v;s+=c+h+o;s+='Content-Disposition: form-data; name="'+u.fileObjName+'"';t.name&&(s+='; filename="'+t.name+'"');s+=o;s+="Content-Type: application/octet-stream"+o+o;s+=e.target.result+o;for(l in u.formData)s+=c+h+o,s+='Content-Disposition: form-data; name="'+l+'"'+o+o,s+=l==="filename"&&t.name?t.name+o:u.formData[l]+o;s+=c+h+c+o;xhr.upload.addEventListener("progress",function(n){r.progress(n,t)},!1);xhr.addEventListener("load",function(n){t.uploading=!1;var u=this.status;u===404?(console.log("%cError: "+this.statusText,LOG_ERROR),r.error("404_FILE_NOT_FOUND",t,i)):t.xhr.responseText.lastIndexOf("error:",0)!==0?r.uploadComplete(n,t,i):r.error(t.xhr.responseText,t,i)},!1);a=u.uploadScript;u.method==="get"&&(v=n(u.formData).param(),a+=v);xhr.open(u.method,u.uploadScript,!0);xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+h);DEBUG_UL5&&console.log("%cAJAX Request: "+a,LOG_TEXT);typeof u.onUploadFile=="function"&&u.onUploadFile.call(f,t);xhr.sendAsBinary(s)},h.readAsBinaryString(t)},r.progress=function(t,i){if(n.inArray("onProgress",u.overrideEvents)<0){var r=-1;t.lengthComputable&&(r=Math.round(t.loaded/t.total*100));i.queueItem.find(".filestatus").html(r+"%");i.queueItem.find(".progress-bar").css("width",r+"%");DEBUG_UL5&&console.log("%cProgress: "+i.name+" "+i.type+" - "+r+"% ",LOG_TEXT)}typeof u.onProgress=="function"&&u.onProgress.call(f,i,t)},r.error=function(i,e,o){if(n.inArray("onError",u.overrideEvents)<0){switch(i){case"404_FILE_NOT_FOUND":errorMsg="404 Error";break;case"403_FORBIDDEN":errorMsg="403 Forbidden";break;case"FORBIDDEN_FILE_TYPE":errorMsg="Forbidden File Type";break;case"FILE_SIZE_LIMIT_EXCEEDED":errorMsg="File Too Large";break;default:errorMsg=i}e.queueItem.addClass("error").find(".filestatus").html(errorMsg);e.queueItem.find(".progress").remove()}typeof u.onError=="function"&&u.onError.call(f,i,e);e.skip=!0;i==="404_FILE_NOT_FOUND"?r.uploads.errors++:r.queue.errors++;o&&t.upload.call(f,null,!0)},r.uploadComplete=function(i,e,o){DEBUG_UL5&&console.log("%cuploadComplete: "+e.name,LOG_SUCCESS);n.inArray("onUploadComplete",u.overrideEvents)<0&&(e.queueItem.find(".progress-bar").css("width","100%"),e.queueItem.find(".filestatus").html("Completed"),e.queueItem.find(".progress").slideUp(250),e.queueItem.addClass("complete"));typeof u.onUploadComplete=="function"&&u.onUploadComplete.call(f,e,e.xhr.responseText);u.removeCompleted&&setTimeout(function(){t.cancel.call(f,e)},2e3);e.complete=!0;r.uploads.successful++;r.uploads.count++;r.uploads.current--;delete e.xhr;o&&t.upload.call(f,null,!0)},r.queueComplete=function(){typeof u.onQueueComplete=="function"&&u.onQueueComplete.call(f,r.uploads)},window.File&&window.FileList&&window.Blob&&(window.FileReader||window.FormData))u.id="uploadifive-"+f.attr("id"),r.button=n('<div id="'+u.id+'" class="uploadifive-button">'+u.buttonText+"<\/div>"),u.buttonClass&&r.button.addClass(u.buttonClass),f.before(r.button).appendTo(r.button).hide(),r.createInput.call(f),u.queueID?r.queueEl=n("#"+u.queueID):(u.queueID=u.id+"-queue",r.queueEl=n('<div id="'+u.queueID+'" class="uploadifive-queue" />'),r.button.after(r.queueEl)),u.dnd&&(e=u.dropTarget?n(u.dropTarget):r.queueEl.get(0),e.addEventListener("dragleave",function(n){n.preventDefault();n.stopPropagation()},!1),e.addEventListener("dragenter",function(n){n.preventDefault();n.stopPropagation()},!1),e.addEventListener("dragover",function(n){n.preventDefault();n.stopPropagation()},!1),e.addEventListener("drop",r.drop,!1)),XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(n){function t(n){return n.charCodeAt(0)&255}var i=Array.prototype.map.call(n,t),r=new Uint8Array(i);this.send(r.buffer)}),typeof u.onInit=="function"&&u.onInit.call(f);else return typeof u.onFallback=="function"&&u.onFallback.call(f),!1})},debug:function(){return this.each(function(){console.log(n(this).data("uploadifive"))})},clearQueue:function(){this.each(function(){var u=n(this),r=u.data("uploadifive"),f=r.settings;for(var e in r.inputs)for(input=r.inputs[e],limit=input.files.length,i=0;i<limit;i++)file=input.files[i],t.cancel.call(u,file);typeof f.onClearQueue=="function"&&f.onClearQueue.call(u,n("#"+r.settings.queueID));r.cleanInputs()})},cancel:function(i,r){this.each(function(){var f=n(this),u=f.data("uploadifive"),e=u.settings;typeof i=="string"&&(isNaN(i)||(fileID="uploadifive-"+n(this).attr("id")+"-file-"+i),i=n("#"+fileID).data("file"));i.skip=!0;u.filesCancelled++;i.uploading&&(u.uploads.current--,i.uploading=!1,i.xhr.abort(),delete i.xhr,t.upload.call(f));n.inArray("onCancel",e.overrideEvents)<0&&u.removeQueueItem(i,r);typeof e.onCancel=="function"&&e.onCancel.call(f,i);u.cleanInputs()})},upload:function(t,i){DEBUG_UL5&&console.log("%cupload",LOG_START);this.each(function(){var f=n(this),r=f.data("uploadifive"),u=r.settings,e;t?r.uploadFile.call(f,t):r.uploads.count+r.uploads.current<u.uploadLimit||u.uploadLimit===0?(i||(r.uploads.attempted=0,r.uploads.successsful=0,r.uploads.errors=0,e=r.filesToUpload(),typeof u.onUpload=="function"&&u.onUpload.call(f,e)),n("#"+u.queueID).find(".uploadifive-queue-item").not(".error, .complete").each(function(){DEBUG_UL5&&console.log("%cupload - Next queue item: "+n(this).data("file").name,LOG_TEXT);var t=u.UploadLimit,i=u.simUploadLimit,f=r.checking,e=r.uploads.current,o=r.uploads.count;e+f>=i&&i!==0||e+f>=t&&t!==0||o>=t&&t!==0?DEBUG_UL5&&(console.log("%cupload - Queue limit reached: "+n(this).data("file").name,LOG_IMPORTANT),console.log("%c    limit: "+t+"\n    sim limit: "+i+"\n    checking: "+f+"\n    uploading: "+e+"\n    uploads: "+o,LOG_TEXT)):u.checkScript?(_file=n(this).data("file"),typeof _file.skip=="undefined"&&typeof _file.uploading=="undefined"&&r.checkExists(_file,!0)):r.startFileUpload(n(this).data("file"))}),n("#"+u.queueID).find(".uploadifive-queue-item").not(".error, .complete").size()===0&&r.queueComplete()):r.uploads.current===0&&(n.inArray("onError",u.overrideEvents)<0&&r.filesToUpload()>0&&u.uploadLimit!==0&&alert("The maximum upload limit has been reached."),typeof u.onError=="function"&&u.onError.call(f,"UPLOAD_LIMIT_EXCEEDED",r.filesToUpload()))})},destroy:function(){this.each(function(){var i=n(this),u=i.data("uploadifive"),r=u.settings;t.clearQueue.call(i);r.queueID||n("#"+r.queueID).remove();i.siblings("input").remove();i.show().insertBefore(u.button);u.button.remove();typeof r.onDestroy=="function"&&r.onDestroy.call(i)})}};n.fn.uploadifive=function(i){if(DEBUG_UL5&&console.log("%cuploadifive: "+i,LOG_START),t[i])return t[i].apply(this,Array.prototype.slice.call(arguments,1));if(typeof i!="object"&&i)n.error("The method "+i+" does not exist in $.uploadify");else return t.init.apply(this,arguments)}})(jQuery);
